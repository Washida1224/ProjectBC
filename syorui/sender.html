<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>バス位置送信(運転手スマホ用)</title>
<style>
  body{font-family:system-ui,sans-serif;margin:0;padding:16px;background:#f9fafb;color:#111}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  input,button{padding:10px 12px;border-radius:8px;border:1px solid #ddd;font-size:14px}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  button.stop{background:#ef4444}
  pre{background:#fff;border:1px solid #eee;border-radius:8px;padding:10px;white-space:pre-wrap}
  .hint{font-size:12px;opacity:.7}
  .ok{background:#dcfce7;color:#166534;padding:3px 6px;border-radius:6px}
  .err{background:#fee2e2;color:#991b1b;padding:3px 6px;border-radius:6px}
</style>
</head>
<body>
<h1>バス位置送信（運転手スマホ用）</h1>

<div class="row">
  <label>API:
    <input id="api" size="40" value="https://pound-baltimore-almost-petersburg.trycloudflare.com" />
  </label>
</div>

<div class="row">
  <label>ドライバー名:
    <input id="name" placeholder="例: 小林賢太郎" />
  </label>
  <label>Route ID:
    <input id="route" value="A01" />
  </label>
</div>

<div class="row">
  <label>Driver ID (自動生成・端末固定):
    <input id="driverId" size="36" readonly />
  </label>
  <span id="state" class="hint">停止中</span>
</div>

<div class="row">
  <button id="start">Start</button>
  <button id="stop" class="stop" disabled>Stop</button>
  <button id="save">台帳に登録/更新</button>
</div>

<p class="hint">※ 初回は「台帳に登録」を押してから Start するのがオススメです。</p>

<h2>ログ</h2>
<pre id="log">---</pre>

<script>
  // ===== 端末固有の driverId を作る（初回のみ） =====
  function uuidv4() {
    // 100%厳密ではないが実運用十分のUUID生成（ブラウザ標準crypto）
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }
  const driverIdEl = document.getElementById('driverId');
  let DRIVER_ID = localStorage.getItem('driverId');
  if (!DRIVER_ID) { DRIVER_ID = uuidv4(); localStorage.setItem('driverId', DRIVER_ID); }
  driverIdEl.value = DRIVER_ID;

  const logEl = document.getElementById('log');
  const stateEl = document.getElementById('state');
  const apiEl = document.getElementById('api');
  const nameEl = document.getElementById('name');
  const routeEl = document.getElementById('route');

  let watchId = null;

  function log(msg){ logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n`+logEl.textContent; }
  function ok(msg){ stateEl.className='ok'; stateEl.textContent=msg; }
  function err(msg){ stateEl.className='err'; stateEl.textContent=msg; }

  async function upsertDriver(){
    const body = {
      driverId: DRIVER_ID,
      name: nameEl.value || null,
      phone: null,
      active: true
    };
    const res = await fetch(`${apiEl.value}/api/drivers/upsert`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (!res.ok) { err('台帳登録エラー'); log(await res.text()); return; }
    ok('台帳登録OK');
    log(`台帳登録: ${JSON.stringify(body)}`);
  }

  async function sendPosition(pos){
    const payload = {
      driverId: DRIVER_ID,
      routeId: routeEl.value || null,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,  // API側は lon/lng どちらも受けられる設定推奨
      speed: pos.coords.speed ?? null,
      heading: pos.coords.heading ?? null,
      accuracy: pos.coords.accuracy ?? null,
      ts: new Date().toISOString()
    };
    try{
      const res = await fetch(`${apiEl.value}/api/locations`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error(await res.text());
      ok('送信中');
      log(`送信OK: ${payload.lat.toFixed(5)}, ${payload.lng.toFixed(5)} route=${payload.routeId}`);
    }catch(e){
      err('送信失敗'); log(`ERR ${e.message}`);
    }
  }

  document.getElementById('save').onclick = upsertDriver;

  document.getElementById('start').onclick = async () => {
    if (!navigator.geolocation) { alert('位置情報APIが使えません'); return; }
    ok('測位中…');
    watchId = navigator.geolocation.watchPosition(
      pos => sendPosition(pos),
      e => { err('位置取得エラー'); log(`位置ERR ${e.message}`); },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
  };

  document.getElementById('stop').onclick = () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    stateEl.className=''; stateEl.textContent='停止中';
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
    log('⏹ 停止');
  };
</script>
</body>
</html>
